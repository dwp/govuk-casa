include:
  - project: dwp/engineering/pipeline-solutions/gitlab/functions
    ref: 3.46.6
    file: functions/node.yml
  - project: dwp/engineering/pipeline-solutions/gitlab/functions
    ref: 3.46.6
    file: functions/auto-tag-merge.yml

variables:
  NODE_IMAGE: node:18.12.0@sha256:cef9966b19672effeafcf1a67b8add742c3e46ca7dd5532efff60820526c2e95
  NODE_PUBLISH_TO_GITLAB: "true"
  AUTO_TAG_MERGE_PREPARE_MR: "true"

# ---------------------------------------------------------- blueprint overrides

node-coverage:
  variables:
    TEST_EXECUTABLE: 'npm run test'

# This is an OSS project so the @dwp scope point to public npm registry. However
# for publishing to the internal GitLab we need to remove that specific config.
node-publish-gitlab:
  before_script:
    - if [ -f .npmrc ]; then sed -i.bak '/^@dwp:registry.*$/d' .npmrc; fi

# ------------------------------------------------------------------ custom jobs

e2e-dast:
  stage: security-dynamic-analysis
  image: $NODE_IMAGE
  tags:
    - docker
  services:
    - name: owasp/zap2docker-stable@sha256:7a669aec036cb47107463c10a722fb581da3e7200b816de3feb92f05ccbcdb03
      alias: zap
      entrypoint: [""]
      command: ["zap.sh", "-daemon", "-host", "0.0.0.0", "-port", "8080", "-config", "api.key=secret", "-config", "api.addrs.addr.name=.*", "-config", "api.addrs.addr.regex=true"]
  needs:
    - node-modules
  variables:
    # ref: https://docs.gitlab.com/runner/executors/docker.html#create-a-network-for-each-job
    # Required so ZAP can connect to servers being spun up in this build container
    FF_NETWORK_PER_BUILD: 1
  script:
    - "until wget -qO- --header 'X-ZAP-Api-Key: secret' http://zap:8080/JSON/core/view/zapHomePath >/dev/null 2>&1; do echo 'Waiting for ZAP ...'; sleep 1; done"
    # We use `|| true` here in order to always generate the report, regardless
    # of failure. We also limit the no. workers so not to overload ZAP (the
    # execution environment is quite constrained)
    - npm run test:e2e -- --workers 4 --zap --zap-proxy 'http://zap:8080/' --zap-target-hostname "$(hostname)" || true
    - "wget -qO- --header 'X-ZAP-Api-Key: secret' http://zap:8080/OTHER/core/other/jsonreport > gl-dast-report.json"
    - "wget -qO- --header 'X-ZAP-Api-Key: secret' http://zap:8080/OTHER/core/other/htmlreport > gl-dast-report.html"
  artifacts:
    when: always
    expire_in: 3 months
    paths:
      - gl-dast-report.html
      - gl-dast-report.json
    reports:
      dast:
        - gl-dast-report.json

# API documentation, published on GitLab Pages
pages:
  stage: publish
  extends: .node-common
  script: npm run build:api-docs -- -d ./public/ || true
  artifacts:
    paths:
      - public
