include:
  - template: DAST.gitlab-ci.yml
  - project: dwp/engineering/pipeline-solutions/gitlab/functions
    ref: 4.19.5
    file:
      - functions/node.yml
      - functions/auto-tag-merge.yml
  - project: dwp/engineering/pipeline-solutions/gitlab/fragments/docker-build
    ref: 4.5.1
    file: /ci-include-docker-build-base.yml

variables:
  NODE_IMAGE: node:18.16.0@sha256:671ee8d49ce2a691fc3082203c5deb9522e0c80042aa0ff40c07f4a25e63668a
  NODE_PUBLISH_TO_GITLAB: "true"
  NODE_PUBLISH_TO_NPMJS: "true"
  AUTO_TAG_MERGE_TAG_BRANCH: "maintain/7.x"
  AUTO_TAG_MERGE_PREPARE_MR: "true"
  DWP_FF_POLICY_DEV211: "true"

# Build the dist/ folder for subsequent stages
build-static-assets:
  extends: .node-common
  stage: build
  script:
    - !reference [.node-init, script]
    - npm run compile-static-assets
  artifacts:
    expire_in: 1 day
    paths:
      - dist/

unit-test:
  extends: .node-common
  parallel:
    matrix:
      - node_image_version: node:16@sha256:7f404d09ceb780c51f4fac7592c46b8f21211474aacce25389eb0df06aaa7472
      - node_image_version: node:20@sha256:242d81ad2a91353ac3a5ed3598582acb4a9a7761b16c60524b949a1603707848
  stage: unit-test
  image: $node_image_version
  script:
    - !reference [.node-init, script]
    - node --version
    - npm --version
    - npm test

# Package up a testable CASA application, ready for dyanmic security tests
zap-package:
  extends:
    - .node-common
    - .docker-build-template
  stage: package
  variables:
    DOCKERFILE_PATH: test/penetration/Dockerfile

dast:
  stage: security-dynamic-analysis
  tags:
    - docker-in-docker
  needs:
    - zap-package
  variables:
    DAST_WEBSITE: http://casa-pentest-app:3000/
    DAST_BROWSER_SCAN: "true"
  services:
    - name: $CI_REGISTRY_IMAGE/$CI_COMMIT_REF_SLUG:$CI_COMMIT_SHA
      alias: casa-pentest-app

# Manipulate publishing process to Gitlab
node-publish-gitlab:
  variables:
    NPM_PUBLISH_TAG: "maintain7x"

# Use a version-specific branch name for auto-packaging
auto-tag-merge-prepare-mr:
  variables:
    MR_BRANCH: chore/auto-package-v7
