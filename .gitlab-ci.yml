include:
  - project: dwp/engineering/pipeline-solutions/gitlab/functions
    ref: 3.58.3
    file: functions/node.yml
  - project: dwp/engineering/pipeline-solutions/gitlab/functions
    ref: 3.58.3
    file: functions/auto-tag-merge.yml


variables:
  NODE_IMAGE: node:18.16.0@sha256:671ee8d49ce2a691fc3082203c5deb9522e0c80042aa0ff40c07f4a25e63668a
  NODE_PUBLISH_TO_GITLAB: "true"
  NODE_PUBLISH_TO_NPMJS: "true"
  AUTO_TAG_MERGE_TAG_BRANCH: "maintain/6.x"
  AUTO_TAG_MERGE_PREPARE_MR: "true"

# ---------------------------------------------------------- blueprint overrides

# The unit tests rely on sources in dist/, and the `prepare` npm script will
# throw a "cannot run in wd" failure due to permissions (in the blueprint,
# `npm ci` is run as root, so we either need `--unsafe-perm` or run manually).
# So we run that manually.
node-modules:
  after_script:
    - npm run prepare
  artifacts:
    expire_in: 1 day
    paths:
      - artifact.tgz
      - node_modules/
      - dist/

unit-test:
  extends: .node-common
  parallel:
    matrix:
      - node_image_version: node:16@sha256:7f404d09ceb780c51f4fac7592c46b8f21211474aacce25389eb0df06aaa7472
      - node_image_version: node:20@sha256:242d81ad2a91353ac3a5ed3598582acb4a9a7761b16c60524b949a1603707848
  stage: unit-test
  image: $node_image_version
  script:
    - node --version
    - npm --version
    - npm test

# Manipulate publishing process to Gitlab
node-publish-gitlab:
  variables:
    NPM_PUBLISH_TAG: "maintain6x"
  before_script:
    # As this is a OSS project, there is an .npmrc setting that points @dwp
    # at the public npm registry. For internal publishing purpses, we need to
    # remove that reference.
    - if [ -f .npmrc ]; then sed -i.bak '/^@dwp:registry.*$/d' .npmrc; fi

# Use a version-specific branch name for auto-packaging
auto-tag-merge-prepare-mr:
  variables:
    MR_BRANCH: chore/auto-package-v6

# Need to use different nod eversion for commitlint
commitlint:
  image: node:20.0.0@sha256:242d81ad2a91353ac3a5ed3598582acb4a9a7761b16c60524b949a1603707848
